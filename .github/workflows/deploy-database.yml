name: Deploy Database Migrations to Azure SQL Server

on:
  workflow_dispatch:  # Solo ejecuciÃ³n manual

jobs:
  validate-scripts:
    name: Validate SQL Scripts
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      # ========================================================
      # 1ï¸âƒ£ Checkout del repositorio
      # ========================================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ========================================================
      # 2ï¸âƒ£ Validar sintaxis de archivos SQL
      # ========================================================
      - name: Validate SQL Syntax
        run: |
          echo "ğŸ” Validando archivos SQL..."
          
          # Verificar que existen archivos SQL
          if [ ! -d "database/migrations" ]; then
            echo "âŒ Error: No existe la carpeta database/migrations"
            exit 1
          fi
          
          # Listar archivos SQL a ejecutar
          echo "ğŸ“„ Scripts de migraciÃ³n encontrados:"
          ls -lh database/migrations/*.sql 2>/dev/null || echo "âš ï¸  No hay scripts de migraciÃ³n"
          
          echo ""
          echo "ğŸ“„ Scripts de seeds encontrados:"
          ls -lh database/seeds/*.sql 2>/dev/null || echo "âš ï¸  No hay scripts de seeds"

      # ========================================================
      # 3ï¸âƒ£ Subir scripts SQL como artefacto
      # ========================================================
      - name: Upload SQL Scripts Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-scripts
          path: database/
          retention-days: 30

  deploy-migrations:
    name: Deploy to Azure SQL Database
    runs-on: ubuntu-latest
    needs: validate-scripts
    
    permissions:
      id-token: write
      contents: read

    steps:
      # ========================================================
      # 4ï¸âƒ£ Descargar artefacto de scripts SQL
      # ========================================================
      - name: Download SQL Scripts Artifact
        uses: actions/download-artifact@v4
        with:
          name: sql-scripts
          path: database

      # ========================================================
      # 5ï¸âƒ£ Login en Azure con identidad federada (OIDC)
      # ========================================================
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # ========================================================
      # 6ï¸âƒ£ Instalar herramientas SQL
      # ========================================================
      - name: Install SQL Server Tools
        run: |
          echo "ğŸ“¦ Instalando SQL Server Tools..."
          
          # Agregar repositorio de Microsoft
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          
          # Actualizar e instalar
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          
          # Agregar al PATH
          echo "/opt/mssql-tools18/bin" >> $GITHUB_PATH
          
          echo "âœ… SQL Server Tools instalado"

      # ========================================================
      # 7ï¸âƒ£ Obtener configuraciÃ³n de SQL Server desde Key Vault
      # ========================================================
      - name: Get SQL Server Configuration
        id: sql-config
        run: |
          echo "ğŸ” Obteniendo configuraciÃ³n desde Key Vault..."
          
          # Obtener nombre de la base de datos
          DB_NAME=$(az keyvault secret show \
            --vault-name ${{ secrets.TF_VAR_KEY_VAULT_NAME }} \
            --name db-database \
            --query value -o tsv)
          
          # Obtener usuario
          DB_USER=$(az keyvault secret show \
            --vault-name ${{ secrets.TF_VAR_KEY_VAULT_NAME }} \
            --name db-username \
            --query value -o tsv)
          
          # Obtener contraseÃ±a
          DB_PASSWORD=$(az keyvault secret show \
            --vault-name ${{ secrets.TF_VAR_KEY_VAULT_NAME }} \
            --name db-password \
            --query value -o tsv)
          
          # Obtener FQDN del SQL Server
          SQL_SERVER=$(az sql server show \
            --name ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
            --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
            --query fullyQualifiedDomainName -o tsv)
          
          # Enmascarar password en logs
          echo "::add-mask::$DB_PASSWORD"
          
          # Exportar como outputs
          echo "DB_NAME=$DB_NAME" >> $GITHUB_OUTPUT
          echo "DB_USER=$DB_USER" >> $GITHUB_OUTPUT
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_OUTPUT
          echo "SQL_SERVER=$SQL_SERVER" >> $GITHUB_OUTPUT
          
          echo "âœ… ConfiguraciÃ³n obtenida exitosamente"
          echo "   Database: $DB_NAME"
          echo "   Server: $SQL_SERVER"
          echo "   User: $DB_USER"

      # ========================================================
      # 8ï¸âƒ£ Configurar acceso temporal al SQL Server
      # ========================================================
      - name: Configure SQL Server Firewall
        id: firewall
        run: |
          echo "ğŸ”¥ Configurando firewall temporal..."
          
          # Obtener IP pÃºblica del runner
          RUNNER_IP=$(curl -s https://api.ipify.org)
          echo "Runner IP: $RUNNER_IP"
          
          # Crear regla temporal de firewall
          az sql server firewall-rule create \
            --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
            --server ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
            --name "GitHubActions-Deploy-$(date +%s)" \
            --start-ip-address $RUNNER_IP \
            --end-ip-address $RUNNER_IP
          
          # Guardar nombre de la regla para cleanup
          echo "FIREWALL_RULE=GitHubActions-Deploy-$(date +%s)" >> $GITHUB_OUTPUT
          
          echo "âœ… Regla de firewall creada"

      # ========================================================
      # 9ï¸âƒ£ Crear backup de la base de datos (ProducciÃ³n)
      # ========================================================
      - name: Create Database Backup
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ’¾ Creando backup de la base de datos..."
          
          # Crear backup en Azure
          BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
          
          echo "âœ… Backup iniciado: $BACKUP_NAME"
          echo "â„¹ï¸  Para producciÃ³n se recomienda configurar long-term retention"

      # ========================================================
      # ğŸ”Ÿ Ejecutar migraciones SQL
      # ========================================================
      - name: Execute Database Migrations
        env:
          SQL_SERVER: ${{ steps.sql-config.outputs.SQL_SERVER }}
          DB_NAME: ${{ steps.sql-config.outputs.DB_NAME }}
          DB_USER: ${{ steps.sql-config.outputs.DB_USER }}
          DB_PASSWORD: ${{ steps.sql-config.outputs.DB_PASSWORD }}
        run: |
          echo "ğŸš€ Ejecutando migraciones de base de datos..."
          
          # Contador de scripts ejecutados
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          # Ejecutar cada script en orden alfabÃ©tico
          for SQL_FILE in $(ls database/migrations/*.sql 2>/dev/null | sort); do
            if [ -f "$SQL_FILE" ]; then
              SCRIPT_NAME=$(basename "$SQL_FILE")
              echo ""
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“„ Ejecutando: $SCRIPT_NAME"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              # Ejecutar script SQL
              if sqlcmd -S "$SQL_SERVER" \
                        -d "$DB_NAME" \
                        -U "$DB_USER" \
                        -P "$DB_PASSWORD" \
                        -C \
                        -i "$SQL_FILE" \
                        -o "${SCRIPT_NAME}.log" 2>&1; then
                
                echo "âœ… $SCRIPT_NAME ejecutado exitosamente"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                
                # Mostrar output
                cat "${SCRIPT_NAME}.log"
              else
                echo "âŒ Error ejecutando $SCRIPT_NAME"
                cat "${SCRIPT_NAME}.log"
                FAILED_COUNT=$((FAILED_COUNT + 1))
                
                # Fallar el workflow si hay error en producciÃ³n
                if [ "${{ github.ref }}" == "refs/heads/main" ]; then
                  echo "âŒ Error crÃ­tico en producciÃ³n - Abortando"
                  exit 1
                fi
              fi
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Resumen de Migraciones"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Exitosas: $SUCCESS_COUNT"
          echo "âŒ Fallidas: $FAILED_COUNT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # ========================================================
      # 1ï¸âƒ£1ï¸âƒ£ Ejecutar seeds (solo si no es producciÃ³n)
      # ========================================================
      - name: Execute Database Seeds
        if: github.ref != 'refs/heads/main'
        env:
          SQL_SERVER: ${{ steps.sql-config.outputs.SQL_SERVER }}
          DB_NAME: ${{ steps.sql-config.outputs.DB_NAME }}
          DB_USER: ${{ steps.sql-config.outputs.DB_USER }}
          DB_PASSWORD: ${{ steps.sql-config.outputs.DB_PASSWORD }}
        run: |
          echo "ğŸŒ± Ejecutando seeds de base de datos..."
          
          # Verificar si existen seeds
          if [ ! -d "database/seeds" ] || [ -z "$(ls -A database/seeds/*.sql 2>/dev/null)" ]; then
            echo "âš ï¸  No hay seeds para ejecutar"
            exit 0
          fi
          
          # Ejecutar cada seed
          for SQL_FILE in $(ls database/seeds/*.sql 2>/dev/null | sort); do
            if [ -f "$SQL_FILE" ]; then
              SCRIPT_NAME=$(basename "$SQL_FILE")
              echo ""
              echo "ğŸ“„ Ejecutando seed: $SCRIPT_NAME"
              
              sqlcmd -S "$SQL_SERVER" \
                      -d "$DB_NAME" \
                      -U "$DB_USER" \
                      -P "$DB_PASSWORD" \
                      -C \
                      -i "$SQL_FILE" \
                      -o "${SCRIPT_NAME}.log"
              
              if [ $? -eq 0 ]; then
                echo "âœ… $SCRIPT_NAME ejecutado"
                cat "${SCRIPT_NAME}.log"
              else
                echo "âš ï¸  Error en $SCRIPT_NAME (no crÃ­tico en develop)"
                cat "${SCRIPT_NAME}.log"
              fi
            fi
          done

      # ========================================================
      # 1ï¸âƒ£2ï¸âƒ£ Verificar estado de la base de datos
      # ========================================================
      - name: Verify Database State
        env:
          SQL_SERVER: ${{ steps.sql-config.outputs.SQL_SERVER }}
          DB_NAME: ${{ steps.sql-config.outputs.DB_NAME }}
          DB_USER: ${{ steps.sql-config.outputs.DB_USER }}
          DB_PASSWORD: ${{ steps.sql-config.outputs.DB_PASSWORD }}
        run: |
          echo "ğŸ” Verificando estado de la base de datos..."
          
          # Obtener lista de tablas
          echo ""
          echo "ğŸ“Š Tablas en la base de datos:"
          sqlcmd -S "$SQL_SERVER" \
                  -d "$DB_NAME" \
                  -U "$DB_USER" \
                  -P "$DB_PASSWORD" \
                  -C \
                  -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' ORDER BY TABLE_NAME;" \
                  -h -1
          
          # Contar registros en tablas principales
          echo ""
          echo "ğŸ“ˆ Conteo de registros:"
          sqlcmd -S "$SQL_SERVER" \
                  -d "$DB_NAME" \
                  -U "$DB_USER" \
                  -P "$DB_PASSWORD" \
                  -C \
                  -Q "
                    SELECT 'niveles' as tabla, COUNT(*) as registros FROM dbo.niveles
                    UNION ALL
                    SELECT 'alumnos', COUNT(*) FROM dbo.alumnos
                    UNION ALL
                    SELECT 'migrations', COUNT(*) FROM dbo.migrations;
                  " \
                  -h -1

      # ========================================================
      # 1ï¸âƒ£3ï¸âƒ£ Limpiar regla de firewall
      # ========================================================
      - name: Remove Firewall Rule
        if: always()
        run: |
          echo "ğŸ§¹ Eliminando regla temporal de firewall..."
          
          # Listar y eliminar reglas temporales de GitHub Actions
          az sql server firewall-rule list \
            --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
            --server ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
            --query "[?contains(name, 'GitHubActions')].name" -o tsv | \
          while read RULE_NAME; do
            echo "Eliminando: $RULE_NAME"
            az sql server firewall-rule delete \
              --resource-group ${{ secrets.TF_VAR_RESOURCE_GROUP_NAME }} \
              --server ${{ secrets.TF_VAR_SQL_SERVER_NAME }} \
              --name "$RULE_NAME" || true
          done
          
          echo "âœ… Firewall limpiado"

      # ========================================================
      # 1ï¸âƒ£4ï¸âƒ£ Notificar resultado
      # ========================================================
      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ RESUMEN DEL DEPLOYMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Entorno: ${{ github.ref_name == 'main' && 'PRODUCCIÃ“N' || 'DESARROLLO' }}"
          echo "ğŸ—„ï¸  Database: ${{ steps.sql-config.outputs.DB_NAME }}"
          echo "ğŸ–¥ï¸  Server: ${{ steps.sql-config.outputs.SQL_SERVER }}"
          echo "ğŸ‘¤ Usuario: ${{ github.actor }}"
          echo "ğŸ“… Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # ========================================================
      # 1ï¸âƒ£5ï¸âƒ£ Azure Logout
      # ========================================================
      - name: Azure Logout
        if: always()
        run: az logout || true
