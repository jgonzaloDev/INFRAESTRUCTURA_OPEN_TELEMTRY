name: Deploy Backend_v2_multimodulo (Spring Boot App)

on:
  workflow_dispatch:  # se ejecuta manualmente desde Actions
  push:
    branches:
      - main
      - develop

permissions:
  id-token: write
  contents: read

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      # =============================
      # 1Ô∏è‚É£ Login en Azure mediante OIDC
      # =============================
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # =============================
      # 2Ô∏è‚É£ Clonar el backend Spring Boot desde su repositorio
      # =============================
      - name: Clonar backend (Spring Boot)
        uses: actions/checkout@v4
        with:
          repository: jgonzaloDev/multimodulo-monolito
          ref: main  # o develop, seg√∫n tu rama
          token: ${{ secrets.GH_PERSONAL_TOKEN }}
          path: backend

      # =============================
      # 3Ô∏è‚É£ Configurar Java 17 y Maven
      # =============================
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # =============================
      # 4Ô∏è‚É£ Compilar el proyecto Spring Boot multimodulo
      # =============================
      - name: Build with Maven
        working-directory: ./backend
        run: |
          echo "üî® Compilando proyecto Spring Boot multimodulo..."
          mvn clean package -DskipTests
          
          echo "‚úÖ Build completado"
          ls -lh target/*.jar || echo "‚ö†Ô∏è  No se encontraron JARs"

      # =============================
      # 5Ô∏è‚É£ Identificar el JAR principal
      # =============================
      - name: Identify Main JAR
        id: jar
        working-directory: ./backend
        run: |
          # Buscar el JAR principal (excluyendo 'original')
          MAIN_JAR=$(find target -name "*.jar" ! -name "*-original.jar" | head -n 1)
          
          if [ -z "$MAIN_JAR" ]; then
            echo "‚ùå No se encontr√≥ ning√∫n JAR compilado"
            exit 1
          fi
          
          echo "JAR_FILE=$MAIN_JAR" >> $GITHUB_OUTPUT
          echo "‚úÖ JAR identificado: $MAIN_JAR"

      # =============================
      # 6Ô∏è‚É£ Desplegar en Azure App Service
      # =============================
      - name: Deploy Spring Boot to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.TF_VAR_APP_SERVICE_NAME }}
          package: ./backend/${{ steps.jar.outputs.JAR_FILE }}

      # =============================
      # 7Ô∏è‚É£ Verificar deployment
      # =============================
      - name: Verify Deployment
        run: |
          echo "üîç Verificando deployment..."
          
          APP_URL="https://${{ secrets.TF_VAR_APP_SERVICE_NAME }}.azurewebsites.net"
          
          echo "üìç URL de la aplicaci√≥n: $APP_URL"
          echo "üè• Health check: $APP_URL/actuator/health"
          
          # Esperar 30 segundos para que la app inicie
          echo "‚è≥ Esperando 30 segundos para que la app inicie..."
          sleep 30
          
          # Verificar health endpoint (opcional)
          if curl -f -s "$APP_URL/actuator/health" > /dev/null 2>&1; then
            echo "‚úÖ Backend desplegado exitosamente y respondiendo"
          else
            echo "‚ö†Ô∏è  Backend desplegado pero health check fall√≥ (puede tardar unos minutos en estar listo)"
          fi

      # =============================
      # 8Ô∏è‚É£ Logout de Azure
      # =============================
      - name: Azure Logout
        if: always()
        run: az logout || true
